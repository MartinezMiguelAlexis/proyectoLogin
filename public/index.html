<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prueba API Node.js</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .endpoint {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
      }
      input,
      button {
        padding: 8px;
        margin: 5px 0;
      }
      button {
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
      }
      button:hover {
        background-color: #45a049;
      }
      pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .error {
        color: red;
      }
      .editable-field {
        background-color: #ffffcc;
        transition: background-color 0.3s;
      }
      .editable-field:focus {
        background-color: #ffffff;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      table,
      th,
      td {
        border: 1px solid #ddd;
      }
      th,
      td {
        padding: 8px;
        text-align: left;
      }
      tr:hover {
        background-color: #f5f5f5;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Prueba de API Node.js</h1>

    <div class="endpoint">
      <h2>Registro</h2>
      <input type="text" id="reg-username" placeholder="Nombre de usuario" />
      <input type="password" id="reg-password" placeholder="Contraseña" />
      <button onclick="registrar()">Registrar</button>
      <pre id="reg-result"></pre>
    </div>

    <div class="endpoint">
      <h2>Login</h2>
      <input type="text" id="login-username" placeholder="Nombre de usuario" />
      <input type="password" id="login-password" placeholder="Contraseña" />
      <button onclick="login()">Login</button>
      <pre id="login-result"></pre>
    </div>

    <div class="endpoint">
      <h2>Perfil (Protegido)</h2>
      <button onclick="perfil()">Obtener Perfil</button>
      <pre id="perfil-result"></pre>
    </div>

    <div class="endpoint">
      <h2>CRUD de Productos</h2>

      <h3>Crear Producto</h3>
      <input type="text" id="prod-nombre" placeholder="Nombre" />
      <input
        type="number"
        id="prod-cantidad"
        placeholder="Cantidad"
        step="0.01"
      />
      <input type="text" id="prod-unidad" placeholder="Unidad (kg, lt, etc)" />
      <input type="date" id="prod-fecha" />
      <button onclick="crearProducto()">Crear Producto</button>
      <pre id="prod-crear-result"></pre>

      <h3>Lista de Productos</h3>
      <button onclick="obtenerProductos()">Obtener Productos</button>
      <div id="productos-lista"></div>

      <h3>Obtener Producto Específico</h3>
      <input type="number" id="prod-id" placeholder="ID del producto" />
      <button onclick="obtenerProducto()">Obtener</button>
      <pre id="prod-obtener-result"></pre>

      <h3>Actualizar Producto</h3>
      <input
        type="number"
        id="prod-actualizar-id"
        placeholder="ID del producto"
        onchange="cargarProductoParaEditar()"
      />
      <input
        type="text"
        id="prod-actualizar-nombre"
        placeholder="Nombre"
        class="editable-field"
      />
      <input
        type="number"
        id="prod-actualizar-cantidad"
        placeholder="Cantidad"
        step="0.01"
        class="editable-field"
      />
      <input
        type="text"
        id="prod-actualizar-unidad"
        placeholder="Unidad"
        class="editable-field"
      />
      <input type="date" id="prod-actualizar-fecha" class="editable-field" />
      <button onclick="actualizarProducto()">Actualizar</button>
      <pre id="prod-actualizar-result"></pre>

      <h3>Eliminar Producto</h3>
      <input
        type="number"
        id="prod-eliminar-id"
        placeholder="ID del producto"
      />
      <button onclick="eliminarProducto()">Eliminar</button>
      <pre id="prod-eliminar-result"></pre>
    </div>

    <div class="endpoint">
      <h2>Pasarela de Pagos</h2>

      <h3>Productos para Pagar</h3>
      <div id="productos-pago">
        <!-- Se agregarán dinámicamente -->
      </div>
      <button onclick="agregarProductoPago()">Agregar Producto</button>

      <h3>Crear Sesión de Pago</h3>
      <button onclick="crearSesionPago()">Crear Pago</button>
      <div id="pago-result"></div>

      <h3>Verificar Pago</h3>
      <input type="text" id="session-id" placeholder="ID de Sesión" />
      <button onclick="verificarPago()">Verificar</button>
      <pre id="verificar-pago-result"></pre>
    </div>

    <div class="endpoint">
      <h2>Gestión de Precios</h2>

      <h3>Actualizar Precio</h3>
      <input
        type="number"
        id="precio-producto-id"
        placeholder="ID del Producto"
      />
      <input
        type="number"
        id="nuevo-precio"
        placeholder="Nuevo precio"
        step="0.01"
        min="0"
      />
      <button onclick="actualizarPrecio()">Actualizar Precio</button>
      <pre id="precio-result"></pre>

      <h3>Historial de Precios</h3>
      <input
        type="number"
        id="historial-producto-id"
        placeholder="ID del Producto"
      />
      <button onclick="obtenerHistorialPrecio()">Obtener Historial</button>
      <div id="historial-precio-container"></div>
    </div>

    <script>
      const API_URL = "http://localhost:3000";
      let token = null;

      function mostrarError(elemento, mensaje) {
        elemento.innerHTML = `<span class="error">${mensaje}</span>`;
      }

      async function registrar() {
        const username = document.getElementById("reg-username").value;
        const password = document.getElementById("reg-password").value;
        const resultElement = document.getElementById("reg-result");

        if (!username || !password) {
          mostrarError(resultElement, "Usuario y contraseña son requeridos");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/registro`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ nombreUsuario: username, password }),
          });

          const data = await response.json();
          resultElement.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      async function login() {
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;
        const resultElement = document.getElementById("login-result"); // Línea 165 corregida

        if (!username || !password) {
          mostrarError(resultElement, "Usuario y contraseña son requeridos");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ nombreUsuario: username, password }),
          });

          const data = await response.json();
          resultElement.textContent = JSON.stringify(data, null, 2);

          if (data.token) {
            token = data.token;
            console.log("Token guardado:", token);
          }
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message); // Línea 167 corregida
        }
      }

      async function perfil() {
        const resultElement = document.getElementById("perfil-result");

        if (!token) {
          mostrarError(resultElement, "Debes iniciar sesión primero");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/perfil`, {
            method: "GET",
            headers: {
              Authorization: token,
            },
          });

          const data = await response.json();
          resultElement.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      // Funciones para el CRUD de productos

      async function crearProducto() {
        const nombre = document.getElementById("prod-nombre").value;
        const cantidad = document.getElementById("prod-cantidad").value;
        const unidad = document.getElementById("prod-unidad").value;
        const fecha = document.getElementById("prod-fecha").value;
        const resultElement = document.getElementById("prod-crear-result");

        if (!nombre || !cantidad || !unidad) {
          mostrarError(
            resultElement,
            "Nombre, cantidad y unidad son requeridos"
          );
          return;
        }

        if (!token) {
          mostrarError(resultElement, "Debes iniciar sesión primero");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/productos`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify({
              nombre,
              cantidad,
              unidad,
              fecha_compra: fecha || new Date().toISOString().split("T")[0],
            }),
          });

          const data = await response.json();
          resultElement.textContent = JSON.stringify(data, null, 2);

          // Limpiar campos después de crear
          if (response.ok) {
            document.getElementById("prod-nombre").value = "";
            document.getElementById("prod-cantidad").value = "";
            document.getElementById("prod-unidad").value = "";
            document.getElementById("prod-fecha").value = "";
            // Actualizar la lista de productos
            await obtenerProductos();
          }
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      async function obtenerProductos() {
        const resultElement = document.getElementById("productos-lista");

        if (!token) {
          mostrarError(resultElement, "Debes iniciar sesión primero");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/productos`, {
            method: "GET",
            headers: {
              Authorization: token,
            },
          });

          const data = await response.json();

          if (data.error) {
            mostrarError(resultElement, data.error);
            return;
          }

          if (data.length === 0) {
            resultElement.innerHTML = "<p>No hay productos registrados</p>";
            return;
          }

          let html =
            "<table><tr><th>ID</th><th>Nombre</th><th>Cantidad</th><th>Unidad</th><th>Fecha</th></tr>";
          data.forEach((producto) => {
            // Formatear la fecha (elimina la parte de tiempo si solo quieres la fecha)
            const fechaOriginal = new Date(producto.fecha_compra);
            const fechaFormateada = producto.fecha_compra.split("T")[0]; // Formato YYYY-MM-DD

            html += `<tr onclick="cargarProductoDesdeTabla(${producto.id})">
                      <td>${producto.id}</td>
                      <td>${producto.nombre}</td>
                      <td>${producto.cantidad}</td>
                      <td>${producto.unidad}</td>
                      <td>${fechaFormateada}</td>
                  </tr>`;
          });
          html += "</table>";

          resultElement.innerHTML = html;
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      async function obtenerProducto() {
        const id = document.getElementById("prod-id").value;
        const resultElement = document.getElementById("prod-obtener-result");

        if (!id) {
          mostrarError(resultElement, "ID del producto es requerido");
          return;
        }

        if (!token) {
          mostrarError(resultElement, "Debes iniciar sesión primero");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/productos/${id}`, {
            method: "GET",
            headers: {
              Authorization: token,
            },
          });

          const data = await response.json();
          resultElement.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      async function cargarProductoParaEditar() {
        const id = document.getElementById("prod-actualizar-id").value;
        const nombreInput = document.getElementById("prod-actualizar-nombre");
        const cantidadInput = document.getElementById(
          "prod-actualizar-cantidad"
        );
        const unidadInput = document.getElementById("prod-actualizar-unidad");
        const fechaInput = document.getElementById("prod-actualizar-fecha");
        const resultElement = document.getElementById("prod-actualizar-result");

        if (!id) {
          // Limpiar campos si no hay ID
          nombreInput.value = "";
          cantidadInput.value = "";
          unidadInput.value = "";
          fechaInput.value = "";
          return;
        }

        if (!token) {
          mostrarError(resultElement, "Debes iniciar sesión primero");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/productos/${id}`, {
            method: "GET",
            headers: {
              Authorization: token,
            },
          });

          const data = await response.json();

          if (response.ok) {
            // Rellenar los campos con los datos del producto
            nombreInput.value = data.nombre || "";
            cantidadInput.value = data.cantidad || "";
            unidadInput.value = data.unidad || "";

            // Formatear la fecha para el input type="date"
            if (data.fecha_compra) {
              const fecha = new Date(data.fecha_compra);
              fechaInput.value = fecha.toISOString().split("T")[0];
            } else {
              fechaInput.value = "";
            }

            resultElement.textContent = "Producto cargado para edición";
          } else {
            mostrarError(
              resultElement,
              data.error || "Error al cargar producto"
            );
            // Limpiar campos si hay error
            nombreInput.value = "";
            cantidadInput.value = "";
            unidadInput.value = "";
            fechaInput.value = "";
          }
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      async function cargarProductoDesdeTabla(productId) {
        document.getElementById("prod-actualizar-id").value = productId;
        await cargarProductoParaEditar();

        // Desplazarse suavemente a la sección de actualización
        document.querySelector(".endpoint h3:nth-of-type(3)").scrollIntoView({
          behavior: "smooth",
        });
      }

      async function actualizarProducto() {
        const id = document.getElementById("prod-actualizar-id").value;
        const nombre = document.getElementById("prod-actualizar-nombre").value;
        const cantidad = document.getElementById(
          "prod-actualizar-cantidad"
        ).value;
        const unidad = document.getElementById("prod-actualizar-unidad").value;
        const fecha = document.getElementById("prod-actualizar-fecha").value;
        const resultElement = document.getElementById("prod-actualizar-result");

        if (!id) {
          mostrarError(resultElement, "ID del producto es requerido");
          return;
        }

        if (!nombre || !cantidad || !unidad) {
          mostrarError(
            resultElement,
            "Nombre, cantidad y unidad son requeridos"
          );
          return;
        }

        if (!token) {
          mostrarError(resultElement, "Debes iniciar sesión primero");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/productos/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify({
              nombre,
              cantidad,
              unidad,
              fecha_compra: fecha || new Date().toISOString().split("T")[0],
            }),
          });

          const data = await response.json();
          resultElement.textContent = JSON.stringify(data, null, 2);

          // Recargar la lista de productos después de actualizar
          if (response.ok) {
            await obtenerProductos();
          }
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      async function eliminarProducto() {
        const id = document.getElementById("prod-eliminar-id").value;
        const resultElement = document.getElementById("prod-eliminar-result");

        if (!id) {
          mostrarError(resultElement, "ID del producto es requerido");
          return;
        }

        if (!token) {
          mostrarError(resultElement, "Debes iniciar sesión primero");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/productos/${id}`, {
            method: "DELETE",
            headers: {
              Authorization: token,
            },
          });

          const data = await response.json();
          resultElement.textContent = JSON.stringify(data, null, 2);

          // Limpiar campo después de eliminar
          if (response.ok) {
            document.getElementById("prod-eliminar-id").value = "";
            // Actualizar la lista de productos
            await obtenerProductos();
          }
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      // Variables para los productos de pago
      let productosPago = [];

      function agregarProductoPago() {
        const contenedor = document.getElementById("productos-pago");
        const id = Date.now(); // Usamos timestamp como ID único temporal

        const div = document.createElement("div");
        div.id = `producto-pago-${id}`;
        div.className = "producto-pago";
        div.innerHTML = `
    <div class="producto-header">
      <h4>Producto</h4>
      <button onclick="eliminarProductoPago(${id})" class="btn-eliminar">×</button>
    </div>
    <div class="producto-fila">
      <label>ID del Producto:</label>
      <input type="number" id="prod-pago-id-${id}" placeholder="Ingresa ID" 
             onchange="cargarProductoParaPago(${id})" class="input-id">
    </div>
    <div class="producto-fila">
      <label>Nombre:</label>
      <input type="text" id="prod-pago-nombre-${id}" readonly class="input-nombre">
    </div>
    <div class="producto-fila">
      <label>Precio Unitario:</label>
      <input type="number" id="prod-pago-precio-${id}" step="0.01" min="0" class="input-precio">
    </div>
    <div class="producto-fila">
      <label>Cantidad:</label>
      <input type="number" id="prod-pago-cantidad-${id}" min="1" value="1" class="input-cantidad">
    </div>
    <div class="producto-fila">
      <label>Stock Disponible:</label>
      <span id="prod-pago-stock-${id}" class="stock-disponible">-</span>
    </div>
  `;

        contenedor.appendChild(div);
        productosPago.push(id);
      }

      function eliminarProductoPago(id) {
        const index = productosPago.indexOf(id);
        if (index > -1) {
          productosPago.splice(index, 1);
          const elemento = document.getElementById(`producto-pago-${id}`);
          if (elemento) elemento.remove();
        }
      }

      async function crearSesionPago() {
        const resultElement = document.getElementById("pago-result");

        if (!token) {
          mostrarError(resultElement, "Debes iniciar sesión primero");
          return;
        }

        // Recopilar datos de los productos
        const productos = [];
        for (const id of productosPago) {
          const productId = document.getElementById(`prod-pago-id-${id}`).value;
          const nombre = document.getElementById(
            `prod-pago-nombre-${id}`
          ).value;
          const precio = parseFloat(
            document.getElementById(`prod-pago-precio-${id}`).value
          );
          const cantidad =
            parseInt(
              document.getElementById(`prod-pago-cantidad-${id}`).value
            ) || 1;

          if (!productId || !nombre || isNaN(precio)) {
            mostrarError(resultElement, `Faltan datos en el producto ${id}`);
            return;
          }

          productos.push({
            productId,
            nombre,
            precio,
            cantidad,
          });
        }

        try {
          console.log("Enviando productos:", productos); // Debug
          console.log("Datos a enviar:", {
            productos: productos.map((p) => ({
              ...p,
              precio: parseFloat(p.precio),
              cantidad: parseInt(p.cantidad),
            })),
          });
          const response = await fetch(`${API_URL}/crear-sesion-pago`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify({ productos }),
          });

          const data = await response.json();
          console.log("Respuesta del servidor:", data); // Debug

          if (data.url) {
            window.open(data.url, "_blank");
            resultElement.innerHTML = `
            <p>Sesión de pago creada exitosamente</p>
            <p>ID de sesión: ${data.id}</p>
            <p>Monto total: $${data.monto_total.toFixed(2)}</p>
            <button onclick="window.open('${data.url}', '_blank')">Ir a Pagar</button>`;
          } else {
            mostrarError(
              resultElement,
              data.error || "No se pudo crear la sesión de pago"
            );
          }
        } catch (error) {
          console.error("Error en crearSesionPago:", error);
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      async function verificarStock(productos) {
        try {
          const response = await fetch(`${API_URL}/verificar-stock`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify({ productos }),
          });

          const data = await response.json();
          return data;
        } catch (error) {
          return { valido: false, mensaje: "Error al verificar stock" };
        }
      }

      // Función auxiliar para verificar productos
      async function verificarProductosPago(productos) {
        try {
          const response = await fetch(`${API_URL}/verificar-productos-pago`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify({ productos }),
          });

          const data = await response.json();

          if (!response.ok) {
            return {
              valido: false,
              mensaje: data.error || "Error al verificar productos",
            };
          }

          // Verificar productos sin stock
          const productosProblema = data.verificaciones.filter(
            (p) => !p.exists || !p.inStock
          );
          if (productosProblema.length > 0) {
            const mensaje = productosProblema
              .map(
                (p) =>
                  `• ${p.nombre || "Producto"}: ${
                    !p.exists ? "No existe" : "Stock insuficiente"
                  }`
              )
              .join("\n");
            return {
              valido: false,
              mensaje: `Problemas con los productos:\n${mensaje}`,
            };
          }

          return { valido: true };
        } catch (error) {
          return {
            valido: false,
            mensaje: "Error al conectar con el servidor",
          };
        }
      }

      // Función auxiliar para copiar ID de sesión
      function copiarAlPortapapeles(texto) {
        navigator.clipboard
          .writeText(texto)
          .then(() => alert("ID copiado al portapapeles"))
          .catch((err) => console.error("Error al copiar:", err));
      }

      async function verificarPago() {
        const sessionId = document.getElementById("session-id").value;
        const resultElement = document.getElementById("verificar-pago-result");

        if (!sessionId) {
          mostrarError(resultElement, "ID de sesión es requerido");
          return;
        }

        if (!token) {
          mostrarError(resultElement, "Debes iniciar sesión primero");
          return;
        }

        try {
          const response = await fetch(
            `${API_URL}/verificar-pago/${sessionId}`,
            {
              method: "GET",
              headers: {
                Authorization: token,
              },
            }
          );

          const data = await response.json();
          resultElement.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      async function verificarProductosPago() {
        const productos = obtenerProductosParaPago(); // Reutiliza la función que recoge los datos del formulario

        try {
          const response = await fetch(`${API_URL}/verificar-productos-pago`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify({ productos }),
          });

          const data = await response.json();

          if (data.verificaciones) {
            // Mostrar resultados al usuario
            const problemas = data.verificaciones.filter(
              (p) => !p.exists || !p.inStock
            );
            if (problemas.length > 0) {
              alert(
                `Problemas con:\n${problemas
                  .map(
                    (p) =>
                      `Producto ${p.productId}: ${
                        !p.exists ? "No existe" : "Stock insuficiente"
                      }`
                  )
                  .join("\n")}`
              );
              return false;
            }
            return true;
          }
          return false;
        } catch (error) {
          console.error("Error verificando productos:", error);
          return false;
        }
      }

      async function cargarProductoParaPago(divId) {
        const productId = document.getElementById(
          `prod-pago-id-${divId}`
        ).value;
        const nombreInput = document.getElementById(
          `prod-pago-nombre-${divId}`
        );
        const precioInput = document.getElementById(
          `prod-pago-precio-${divId}`
        );
        const stockSpan = document.getElementById(`prod-pago-stock-${divId}`);

        if (!productId) {
          nombreInput.value = "";
          precioInput.value = "";
          stockSpan.textContent = "-";
          return;
        }

        try {
          const response = await fetch(`${API_URL}/productos/${productId}`, {
            method: "GET",
            headers: {
              Authorization: token,
            },
          });

          const data = await response.json();

          if (response.ok) {
            nombreInput.value = data.nombre || "";
            precioInput.value = data.precio_actual || "";
            stockSpan.textContent = data.cantidad || "0";

            // Mostrar tooltip con historial de precios
            const historialResponse = await fetch(
              `${API_URL}/productos/${productId}/precio/historial`,
              {
                headers: { Authorization: token },
              }
            );
            const historial = await historialResponse.json();

            if (historial.length > 0) {
              precioInput.title =
                "Historial de precios:\n" +
                historial
                  .map(
                    (p) =>
                      `${p.precio} (${new Date(
                        p.fecha_inicio
                      ).toLocaleDateString()} - ${
                        p.fecha_fin
                          ? new Date(p.fecha_fin).toLocaleDateString()
                          : "actual"
                      })`
                  )
                  .join("\n");
            }
          } else {
            mostrarError(`producto-pago-${divId}`, "Producto no encontrado");
            nombreInput.value = "";
            precioInput.value = "";
            stockSpan.textContent = "-";
          }
        } catch (error) {
          console.error("Error al cargar producto:", error);
          mostrarError(`producto-pago-${divId}`, "Error al cargar producto");
        }
      }

      async function actualizarPrecio() {
        const productId = document.getElementById("precio-producto-id").value;
        const nuevoPrecio = document.getElementById("nuevo-precio").value;
        const resultElement = document.getElementById("precio-result");

        if (!productId || !nuevoPrecio) {
          mostrarError(resultElement, "ID y precio son requeridos");
          return;
        }

        try {
          const response = await fetch(
            `${API_URL}/productos/${productId}/precio`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: token,
              },
              body: JSON.stringify({ nuevoPrecio }),
            }
          );

          const data = await response.json();
          resultElement.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          mostrarError(resultElement, "Error: " + error.message);
        }
      }

      async function obtenerHistorialPrecio() {
        const productId = document.getElementById(
          "historial-producto-id"
        ).value;
        const container = document.getElementById("historial-precio-container");

        if (!productId) {
          mostrarError(container, "ID del producto es requerido");
          return;
        }

        try {
          const response = await fetch(
            `${API_URL}/productos/${productId}/precio/historial`,
            {
              headers: { Authorization: token },
            }
          );

          const historial = await response.json();

          if (historial.length === 0) {
            container.innerHTML =
              "<p>No hay historial de precios para este producto</p>";
            return;
          }

          let html =
            "<table><tr><th>Precio</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Usuario</th></tr>";
          historial.forEach((p) => {
            html += `
        <tr>
          <td>$${p.precio.toFixed(2)}</td>
          <td>${new Date(p.fecha_inicio).toLocaleDateString()}</td>
          <td>${
            p.fecha_fin ? new Date(p.fecha_fin).toLocaleDateString() : "Actual"
          }</td>
          <td>${p.nombreUsuario}</td>
        </tr>
      `;
          });
          html += "</table>";

          container.innerHTML = html;
        } catch (error) {
          mostrarError(container, "Error: " + error.message);
        }
      }
    </script>
  </body>
</html>
